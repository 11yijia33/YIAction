name: è®¨è®ºåŒºæ–°è®¨è®ºé€šçŸ¥åˆ°ä¼ä¸šå¾®ä¿¡ç¾¤

# è§¦å‘æ¡ä»¶ï¼šå½“è®¨è®ºè¢«åˆ›å»ºæ—¶
on:
  discussion:
    types: [created]

# æƒé™è®¾ç½®ï¼šä»…éœ€è¦è¯»å–å†…å®¹çš„æƒé™
permissions:
  contents: read
  discussions: read

jobs:
  notify-wechat-group:
    name: å‘é€è®¨è®ºé€šçŸ¥åˆ°ä¼ä¸šå¾®ä¿¡ç¾¤
    runs-on: ubuntu-latest
    steps:
      - name: è¾“å‡ºè®¨è®ºåŸºæœ¬ä¿¡æ¯ï¼ˆè°ƒè¯•ç”¨ï¼‰
        run: |
          echo "è®¨è®ºæ ‡é¢˜: ${{ github.event.discussion.title }}"
          echo "è®¨è®ºä½œè€…: ${{ github.event.discussion.user.login }}"
          echo "è®¨è®ºé“¾æ¥: ${{ github.event.discussion.html_url }}"

      - name: å‘é€æ¶ˆæ¯åˆ°ä¼ä¸šå¾®ä¿¡ç¾¤
        run: |
          # æ„é€ ä¼ä¸šå¾®ä¿¡æ”¯æŒçš„Markdownæ¶ˆæ¯
          MESSAGE=$(cat <<EOF
          {
            "msgtype": "markdown",
            "markdown": {
              "content": "### ğŸŒŸ æ–°è®¨è®ºé€šçŸ¥\n\n"
              "**è®¨è®ºæ ‡é¢˜**ï¼š[${{ github.event.discussion.title }}](${{ github.event.discussion.html_url }})\n\n"
              "**å‘èµ·è€…**ï¼š[@${{ github.event.discussion.user.login }}](https://github.com/${{ github.event.discussion.user.login }})\n\n"
              "**è®¨è®ºé“¾æ¥**ï¼š${{ github.event.discussion.html_url }}\n\n"
              "> ğŸ’¡ æ¬¢è¿ç‚¹å‡»é“¾æ¥å‚ä¸è®¨è®ºï¼ŒåŠ©åŠ›ç¤¾åŒºå»ºè®¾ï¼"
            }
          }
          EOF
          )

          # å‘é€è¯·æ±‚åˆ°ä¼ä¸šå¾®ä¿¡ç¾¤æœºå™¨äºº
          RESPONSE=$(curl -s -w "%{http_code}" -X POST \
            -H "Content-Type: application/json" \
            -d "$MESSAGE" \
            "${{ secrets.WECHAT_GROUP_WEBHOOK }}"
          )

          # æå–HTTPçŠ¶æ€ç å’Œå“åº”å†…å®¹
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          RESPONSE_BODY=$(echo "$RESPONSE" | head -n -1)

          # æ£€æŸ¥å‘é€ç»“æœ
          if [ "$HTTP_CODE" -eq 200 ] && [ "$(echo "$RESPONSE_BODY" | jq -r '.errcode')" -eq 0 ]; then
            echo "âœ… é€šçŸ¥å·²æˆåŠŸå‘é€åˆ°ä¼ä¸šå¾®ä¿¡ç¾¤"
          else
            echo "âŒ é€šçŸ¥å‘é€å¤±è´¥"
            echo "çŠ¶æ€ç : $HTTP_CODE"
            echo "å“åº”å†…å®¹: $RESPONSE_BODY"
            exit 1
          fi
        env:
          # ç¡®ä¿å·²åœ¨GitHub Secretsä¸­é…ç½®æ­¤å˜é‡
          WECHAT_GROUP_WEBHOOK: ${{ secrets.WECHAT_GROUP_WEBHOOK }}
